#include "types.h"
#include "io.h"
#include "mmu.h"
#include "dev/ide.h"
#include "fs/fat.h"
#include "fs/fs.h"

static int
count(char** argv)
{
    char** s;
    uint i;
    // the last value is 0
    for (s=argv;*s != 0;s++,i++);
    return i;
}

extern struct fdir  root;

// dump write
char* buf = "11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
11223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344556611223344556677889900112233445566\
aabbccdd##667788990011223344556611223344556677889900112233445566112233445566778899001122334455661122334455667788990011223344}}||";

int
exec(uint eip,char* path,char** argv)
{
    sti();
    sleep(1);
    
    fat_init(&root,1,"root");
    fat_create(&root,"tmp",2048,FT_DIR);
    fat_init_fdir(&root);

    fat_create(root.cur[2].p,"opt",2048,FT_DIR);
    fat_create(root.cur[2].p,"a.txt",2048,FT_FILE);
    fat_init_fdir(root.cur[2].p);
    // fat_write(root.cur[2].p,"a.txt",buf,strlen(buf));

    // fat_create(root.cur[2].p->cur[2].p,"c.txt",2048,FT_FILE);
    // fat_init_fdir(root.cur[2].p->cur[2].p);

    // fnode_dump(&root.cur[2].p->cur[2].p->cur[2]);
    // fat_write(root.cur[2].p->cur[2].p,"c.txt",buf,strlen(buf));
    fat_clean(1);

    for(;;)
        ;

    return -1;
}
